{% extends "base.html" %}
{% block content %}

<div class="min-h-screen bg-gray-50 py-10 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Admin Dashboard</h1>

    <!-- Overview Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <!-- Total Users -->
      <div class="stat-card card-modern rounded-2xl p-6 text-center hover-lift">
        <div class="w-16 h-16 bg-blue-600 rounded-xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-users text-white text-2xl"></i>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">{{ users|length }}</div>
        <div class="text-gray-600">Total Users</div>
      </div>

      <!-- Admin Users -->
      <div class="stat-card card-modern rounded-2xl p-6 text-center hover-lift">
        <div class="w-16 h-16 bg-green-600 rounded-xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-user-shield text-white text-2xl"></i>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">
            {{ users|selectattr('role', 'equalto', 'admin')|list|length }}
        </div>
        <div class="text-gray-600">Admin Users</div>
      </div>

      <!-- Total Predictions - Button -->
      <div class="stat-card card-modern rounded-2xl p-6 text-center hover-lift cursor-pointer" onclick="togglePredictionDetails()">
        <div class="w-16 h-16 bg-purple-600 rounded-xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-chart-line text-white text-2xl"></i>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">
          {% set total_predictions = users | map(attribute='predictions') | map('length') | sum %}
          {{ total_predictions if total_predictions else 0 }}
        </div>
        <div class="text-gray-600">Total Predictions</div>
      </div>

      <!-- System Uptime -->
      <div class="stat-card card-modern rounded-2xl p-6 text-center hover-lift">
        <div class="w-16 h-16 bg-yellow-500 rounded-xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-clock text-white text-2xl"></i>
        </div>
        <div class="text-2xl font-bold text-gray-900 mb-1">99.9%</div>
        <div class="text-gray-600">System Uptime</div>
      </div>
    </div>

    <!-- User Management -->
    <div class="bg-white shadow rounded-xl p-6 mb-10">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold text-gray-900">User Management</h2>
        <form method="GET" action="{{ url_for('routes.admin_dashboard') }}" class="flex space-x-2">
          <input type="text" name="search" placeholder="Search users..." class="input-modern" />
          <button type="submit" class="btn-modern bg-blue-600 text-white rounded-md px-4 py-2">Search</button>
        </form>
      </div>
      <div class="overflow-auto rounded-xl border border-gray-200">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">User</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Email</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Role</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Joined</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            {% for user in users %}
            <tr>
              <td class="px-4 py-2">{{ user.username }}</td>
              <td class="px-4 py-2">{{ user.email }}</td>
              <td class="px-4 py-2">{{ user.role }}</td>
              <td class="px-4 py-2">{{ user.created_at.strftime('%b %d, %Y') }}</td>
              <td class="px-4 py-2">
                {% if current_user.id == user.id %}
                  You
                {% else %}
                  {% if user.role != 'admin' %}
                    <a href="{{ url_for('routes.promote_user', user_id=user.id) }}"
                      class="text-blue-600 hover:underline mr-2"
                      onclick="return confirm('Are you sure you want to promote this user as admin? This change is permanent.');">
                      Promote
                    </a>
                  {% endif %}
                  <a href="{{ url_for('routes.delete_user', user_id=user.id) }}"
                    class="text-red-600 hover:underline"
                    onclick="return confirm('{{ 'This user has prediction history. Are you sure you want to delete all their data?' if user.predictions|length > 0 else 'Are you sure you want to delete this user?' }}');">
                    Delete
                  </a>
                {% endif %}
              </td>

              
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Hidden Predictions Detail Section -->
    <div id="predictionDetails" class="mt-10 hidden">
      <h2 class="text-2xl font-bold text-gray-900 mb-4">All User Predictions</h2>
      <div class="overflow-auto rounded-xl border border-gray-200">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">User</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Email</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Prediction</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Score</th>
              <th class="px-4 py-3 text-left font-semibold text-gray-700">Date</th>
            </tr>
          </thead>
          <tbody class="divide-y">
            {% for user in users %}
              {% for pred in user.predictions %}
              <tr>
                <td class="px-4 py-2">{{ user.username }}</td>
                <td class="px-4 py-2">{{ user.email }}</td>
                <td class="px-4 py-2">{{ pred.result }}</td>
                <td class="px-4 py-2">{{ '%.2f' % pred.score }}</td>
                <td class="px-4 py-2">{{ pred.created_at.strftime('%Y-%m-%d') }}</td>
              </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function togglePredictionDetails() {
    const section = document.getElementById('predictionDetails');
    section.classList.toggle('hidden');
  }
</script>

{% endblock %}